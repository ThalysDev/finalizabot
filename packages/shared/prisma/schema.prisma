// ──────────────────────────────────────────────────────────────
// FinalizaBOT — Unified Prisma Schema (public + etl schemas)
// ──────────────────────────────────────────────────────────────

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DATABASE_URL_UNPOOLED")
  schemas   = ["public", "etl"]
}

// ============================================================================
// PUBLIC SCHEMA — FinalizaBOT Web (frontend models)
// ============================================================================

model Player {
  id            String              @id @default(cuid())
  sofascoreId   String              @unique
  name          String
  position      String
  sofascoreUrl  String
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  matchStats     PlayerMatchStats[]
  marketAnalyses MarketAnalysis[]
  favoritedBy    UserFavorite[]

  @@schema("public")
}

model Match {
  id            String              @id @default(cuid())
  sofascoreId   String              @unique
  homeTeam      String
  awayTeam      String
  competition   String
  matchDate     DateTime
  status        String              @default("scheduled")
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  playerStats    PlayerMatchStats[]
  marketAnalyses MarketAnalysis[]

  @@schema("public")
}

model PlayerMatchStats {
  id            String   @id @default(cuid())
  playerId      String
  matchId       String
  goals         Int      @default(0)
  assists       Int      @default(0)
  shots         Int      @default(0)
  shotsOnTarget Int      @default(0)
  minutesPlayed Int      @default(0)
  rating        Float?
  createdAt     DateTime @default(now())

  player Player @relation(fields: [playerId], references: [id])
  match  Match  @relation(fields: [matchId], references: [id])

  @@unique([playerId, matchId])
  @@schema("public")
}

model MarketAnalysis {
  id             String   @id @default(cuid())
  playerId       String
  matchId        String
  market         String
  odds           Float
  probability    Float
  confidence     Float
  recommendation String
  reasoning      String
  createdAt      DateTime @default(now())

  player Player @relation(fields: [playerId], references: [id])
  match  Match  @relation(fields: [matchId], references: [id])

  @@schema("public")
}

// ── User & Subscription ─────────────────────────────────────────────────

model User {
  id            String         @id @default(cuid())
  clerkId       String         @unique
  email         String         @unique
  name          String?
  tier          UserTier       @default(FREE)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  subscription  Subscription?
  favorites     UserFavorite[]
  alertSettings AlertSettings?

  @@schema("public")
}

model Subscription {
  id                   String             @id @default(cuid())
  userId               String             @unique
  plan                 SubscriptionPlan   @default(PRO_MONTHLY)
  status               SubscriptionStatus @default(ACTIVE)
  stripeCustomerId     String?            @unique
  stripeSubscriptionId String?            @unique
  stripePriceId        String?
  currentPeriodStart   DateTime?
  currentPeriodEnd     DateTime?
  cancelAtPeriodEnd    Boolean            @default(false)
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@schema("public")
}

model UserFavorite {
  id        String   @id @default(cuid())
  userId    String
  playerId  String
  createdAt DateTime @default(now())

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  player Player @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@unique([userId, playerId])
  @@schema("public")
}

model AlertSettings {
  id           String   @id @default(cuid())
  userId       String   @unique
  pushEnabled  Boolean  @default(true)
  emailEnabled Boolean  @default(false)
  silentMode   Boolean  @default(false)
  minRoi       Float    @default(10)
  maxCv        Float    @default(0.5)
  leagues      String[] @default(["Premier League", "La Liga", "Champions League"])
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@schema("public")
}

// ── Enums ────────────────────────────────────────────────────────────────

enum UserTier {
  FREE
  PRO

  @@schema("public")
}

enum SubscriptionPlan {
  PRO_MONTHLY
  PRO_ANNUAL

  @@schema("public")
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  INCOMPLETE

  @@schema("public")
}

// ============================================================================
// ETL SCHEMA — SofaScore ETL (scraping/ingestion models)
// ============================================================================

model EtlTeam {
  id       String  @id
  name     String
  slug     String?
  imageUrl String?

  currentTeamPlayers EtlPlayer[]      @relation("CurrentTeam")
  homeMatches        EtlMatch[]       @relation("HomeTeam")
  awayMatches        EtlMatch[]       @relation("AwayTeam")
  matchPlayers       EtlMatchPlayer[]
  shotEvents         EtlShotEvent[]

  @@map("Team")
  @@schema("etl")
}

model EtlPlayer {
  id            String  @id
  name          String
  slug          String?
  position      String?
  imageUrl      String?
  currentTeamId String?

  currentTeam  EtlTeam?         @relation("CurrentTeam", fields: [currentTeamId], references: [id])
  matchPlayers EtlMatchPlayer[]
  shotEvents   EtlShotEvent[]

  @@map("Player")
  @@schema("etl")
}

model EtlMatch {
  id         String   @id
  tournament String?
  season     String?
  startTime  DateTime
  homeTeamId String
  awayTeamId String

  homeTeam     EtlTeam          @relation("HomeTeam", fields: [homeTeamId], references: [id])
  awayTeam     EtlTeam          @relation("AwayTeam", fields: [awayTeamId], references: [id])
  matchPlayers EtlMatchPlayer[]
  shotEvents   EtlShotEvent[]

  @@index([homeTeamId])
  @@index([awayTeamId])
  @@index([startTime])
  @@map("Match")
  @@schema("etl")
}

model EtlMatchPlayer {
  matchId       String
  playerId      String
  teamId        String
  minutesPlayed Int?

  match  EtlMatch  @relation(fields: [matchId], references: [id], onDelete: Cascade)
  player EtlPlayer @relation(fields: [playerId], references: [id], onDelete: Cascade)
  team   EtlTeam   @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@id([matchId, playerId])
  @@index([playerId])
  @@index([teamId])
  @@map("MatchPlayer")
  @@schema("etl")
}

model EtlShotEvent {
  id        String   @id
  matchId   String
  playerId  String
  teamId    String
  minute    Int
  second    Int?
  type      String
  outcome   String
  xg        Float?
  bodyPart  String?
  situation String?
  coordsX   Float?
  coordsY   Float?
  createdAt DateTime @default(now())

  match  EtlMatch  @relation(fields: [matchId], references: [id], onDelete: Cascade)
  player EtlPlayer @relation(fields: [playerId], references: [id], onDelete: Cascade)
  team   EtlTeam   @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@index([matchId])
  @@index([playerId])
  @@index([teamId])
  @@index([minute])
  @@index([matchId, minute])
  @@map("ShotEvent")
  @@schema("etl")
}

model EtlIngestRun {
  id         String    @id @default(cuid())
  startedAt  DateTime  @default(now())
  finishedAt DateTime?
  status     String
  error      String?   @db.Text

  @@index([status])
  @@index([startedAt])
  @@map("IngestRun")
  @@schema("etl")
}
