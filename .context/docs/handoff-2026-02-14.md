# Handoff Técnico e Próximos Ciclos (2026-02-14)

## Objetivo
Consolidar o estado atual do hardening/otimização e definir execução autônoma dos próximos ciclos com prioridade, risco e critério de aceite.

## Resumo Executivo
- Web/API: contratos e validações centrais já padronizados em rotas críticas (`matches`, `matches/[id]`, `players/[id]`, `search`, `user/*`, `debug-table`, `image-proxy`, `images/[id]`).
- Segurança: middleware centralizado por `isPublicPath`, auth protegendo rotas privadas, rate-limit aplicado em endpoints sensíveis.
- Qualidade: pipeline consolidado com `quality:ci` (lint + test + build + build:etl), smoke script operacional (`scripts/verify-deployment.ps1`).
- Observabilidade: logger web estruturado e resiliente a payload circular; ainda existe logging verboso em fluxos de debug/tabela.

## Riscos e Débito Técnico (priorizado)

### P0 — Alto impacto operacional
1. **Verbose logs em runtime de páginas/rotas**
   - Evidência: `console.log(...)` em:
     - `apps/web/src/app/api/debug-table/route.ts`
     - `apps/web/src/app/(protected)/dashboard/table/page.tsx`
     - `apps/web/src/data/fetchers/dashboard.ts`
   - Risco: ruído operacional, custo de log, risco de vazamento de contexto interno.
   - Ação: migrar para `logger.debug/info` com flag de ambiente (`DEBUG_*`) e payload mínimo.
   - Aceite: nenhum `console.log` em caminhos de produção; logs só estruturados.

2. **Regras de lint de pureza relaxadas no baseline**
   - Evidência: `react-hooks/purity` e `react-hooks/set-state-in-effect` desabilitadas em `apps/web/eslint.config.mjs`.
   - Risco: regressões de render/performance passarem despercebidas.
   - Ação: plano de remoção gradual da exceção por pasta/componente.
   - Aceite: reativação parcial (warn/error) com backlog de componentes corrigidos.

### P1 — Correção/performance incremental
3. **Overfetch residual em rotas de detalhe**
   - Contexto: houve redução em `debug-table`; ainda revisar `players/[id]` e `matches/[id]` para campos estritamente consumidos.
   - Risco: latência e payload maiores que o necessário.
   - Ação: revisar `include` vs `select`, limitar relacionamentos e ordenar apenas quando necessário.
   - Aceite: payload reduzido sem quebra de contrato de resposta.

4. **Documentação operacional legada dispersa**
   - Evidência: documentos históricos já marcados como potencialmente desatualizados no índice de docs.
   - Risco: runbooks conflitantes em incidentes.
   - Ação: manter um runbook canônico e anotar legados como referência histórica.
   - Aceite: fonte de verdade única para deploy/rollback/smoke.

### P2 — Melhoria contínua
5. **Cobertura de testes de contratos por rota**
   - Hoje: boa cobertura de utilitários/sanitização/responses.
   - Gap: falta matriz explícita por endpoint (status/headers/payload) em cenários inválidos e auth.
   - Ação: adicionar suíte orientada a contrato para endpoints públicos e protegidos.
   - Aceite: cada endpoint crítico com casos 2xx/4xx/5xx essenciais.

## Plano de Execução (sem micro-confirmações)

### Ciclo A — Observabilidade limpa (P0)
- Substituir `console.log` por `logger` nos fluxos de dashboard/debug-table.
- Introduzir gates de debug por env (`DEBUG_TABLE_VERBOSE`, `DEBUG_DASHBOARD_FETCH`).
- Validar `quality:ci` + smoke detalhado.

### Ciclo B — Reativação gradual de lint de pureza (P0/P1)
- Fase 1: habilitar como `warn` e corrigir componentes mais críticos.
- Fase 2: elevar para `error` nos caminhos já saneados.
- Fase 3: remover override global.

### Ciclo C — Performance de payload (P1)
- Auditar queries de `players/[id]` e `matches/[id]`.
- Reduzir seleção de campos e manter cache headers consistentes.
- Validar regressão via testes + build.

### Ciclo D — Contratos e runbooks (P1/P2)
- Consolidar matriz de contratos de API.
- Unificar documentação de operação (deploy/smoke/rollback).

## Critérios de Saída por Ciclo
- `npm run quality:ci` verde.
- `powershell -ExecutionPolicy Bypass -File scripts/verify-deployment.ps1 -Detailed` verde.
- Commit pequeno e focado, com resumo de impacto.

## Comandos Padrão
- Gate local/CI: `npm run quality:ci`
- Smoke: `powershell -ExecutionPolicy Bypass -File scripts/verify-deployment.ps1 -Detailed`

## Decisões já tomadas (não reabrir sem necessidade)
- Sem diferenciação FREE vs PRO neste momento.
- Foco em hardening, consistência de API e estabilidade operacional.
- Entregas incrementais em `main` com validação completa por lote.
